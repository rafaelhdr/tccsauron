\section{Progressos}
\label{sec:progressos}

Como foi especificado no documento de especificação, nós seguiremos a arquitetura indicada na figura~\ref{arquitetura:global} abaixo.

\begin{figure}[h]%
\begin{center}
\includegraphics[width=.5\columnwidth]{imagens/arquitetura.jpg}
\caption{Arquitetura do Sistema completo.}%
\label{arquitetura:global}%
\end{center}
\end{figure}

Odômetros e sonares são sensores presentes na plataforma-robô Pionner P2DX. A Visão será provida por uma câmera comercial de baixo custo. Nossos testes estão sendo realizados com a HS988 da Raysun Shine e com a Microsoft LifeCam VX1000.

Nossos progressos concentraram-se no Módulo de Localização, cuja arquitetura se baseia no uso do estimador bayesiano conhecido por Filtro Estendido de Kalman. A arquitetura detalhada do Módulo de Localização encontra-se na figura~\ref{arquitetura:localizacao} abaixo.

\begin{figure}[h]%
\begin{center}
\includegraphics[width=.5\columnwidth]{imagens/arquitetura_localizacao.jpg}
\caption{Arquitetura Detalhada do Módulo de Localização.\cite{barra}}%
\label{arquitetura:localizacao}%
\end{center}
\end{figure}

Os trabalhos do último mês resultaram em um avanço considerável no módulo de localização.

\subsection{Arquitetura do Sistema}
Todos os módulos do sistema foram integrados, e os testes do sistema completo começaram, no simulador. Uma arquitetura de software fortemente assíncrona e desacoplada foi desenvolvida, com resultados satisfatórios. Além disso, um sistema de log foi criado, para auxiliar o diagnóstico de erros. Os logs se provaram essenciais para A arquitetura do sistema é descrita na seção \ref{sec:arquitetura}.

Primeiramente, um sistema centralizado foi construído, mas ele apresentava dois problemas: desperdício de processamento e excesso de logs. Para evitar isso, um sistema mais complexo, assíncrono foi desenvolvido. Ele apresentou desempenho muito melhor, e passou a gerar logs muito mais concisos.

\subsection{Filtro Estendido de Kalman (EKF)}
O código do filtro estendido de Kalman, EKF, foi implementado e testado no simulador, sendo que inicialmente foi testado o modelo de dinâmica isoladamente de forma a corrigir erros na etapa de predição do modelo e depois com o modelo de dinâmica conjuntamente do sonar, a fim de testar a etapa de atualização do filtro. O EKF é detalhado na seção \ref{sec:kalman}.

\subsection{Modelo de Dinâmica}
O Modelo de Dinâmica encontra-se finalizado e testado. Após a primeira implementação houve mudanças relativas a dois quesitos:

1. Interfaceamento com o ôdometro do Robô.

2. Integração dos Módulos do Sistema.

As mudanças relativas ao interfaceamento com o ôdometro do robô se justificam pela forma inesperada que o odômetro trabalhava em relação ao ângulo de deslocamento. O odômetro acumulava a variaçao de ângulo sempre positivamente, independente do sentido de deslocamento angular. Uma pequena correção utilizando o sinal de controle do robô de velocidade rotacional corrigiu esse problema, ao adicionar o sentido correto ao deslocamento angular.

Essa mudança foi traumática porque nos primeiros testes, por desatenção da equipe, utilizamos apenas curvas para o mesmo sentido, e o Modelo de Dinâmica foi considerado aprovado. Após a integração com os Sonares, testes mais detalhados revelaram o problema, que acreditava-se estar nos Sonares.

A integração dos Módulos do Sistema também exigiu reestruturação do Módulo, mas de forma bem menos traumática do que a mudança anterior, pois já estava planejada. 

\subsection{Modelo de Sonares}
Com a integração do modelo de dinâmica e do EKF, o teste integrado dos sonares pôde começar. Até agora, só foram realizados testes no simulador. A dificuldade em verificar exatamente o que está acontecendo em um teste diminui o ritmo de progressos, mas o sistema de log foi fundamental para consertar a maior parte dos erros.

Os testes revelaram também erros teóricos que havíamos cometidos. Por exemplo, apesar de termos mudado a equação que dá a observação esperada, não mudamos a matriz H. As equações finais podem ser vistas na seção \ref{sec:sonar}.

\subsection{Modelo de Visão}
O modelo de visão já foi implementado, porém os testes em ambiente simulado são muito difíceis de se realizar, pois necessitam da sincronização da posição do robô com as possíveis imagens visualizadas por ele. Dessa forma, os testes serão realizados apenas em campo e aguardaram as correções do sonar feitas em ambiente simulado. 

Seção \ref{sec:visao}.

\subsection{Testes}

Todos os testes até agora foram realizados no simulador fornecido pela MobileRobots. Foram testados o modelo de dinâmica, o EKF e o modelo dos sonares - esse úlitmo notadamente o mais complicado de todos. O simulador insere erros aleatórios nas medidas dos odômetros e dos sonares, mas experiências anteriores nos indicam que ele é significativamente otimista quanto à variâncicia das medidas, se comparado com os sensores reais. Contudo, é primordial que o sistema primeiro funcione no simulador, para então passarmos aos testes com o robô real.

Os testes no simulador combinados com o sistema de logs, nos permitiu resolver inúmeros \textit{bugs} em todos os módulos do sistema. Dos três módulos que foram testados, o EKF está finalizado e (aparentemente) sem erros; o modelo de dinâmica e o modelo dos sonares estão em fase final de aprimoramento.

\subsubsection{Dados experimentais} 

Os testes foram feitos no mapa da figura \ref{fig:pavsup}, o pavimento superior do prédio de Engenharia Elétrica. Este é um bom caso de testes por alguns motivos:

\begin{itemize}
	\item Alta simetria, o que é desafiador para o sonar.
	\item Vão central, onde os sonares perdem quaisquer referências e costumam fazer associações erradas.
\end{itemize}

\begin{figure}
	\centering
	\includegraphics[width=.8\columnwidth]{imagens/mapa2.jpeg}
	\caption{Mapa utilizado para testes}
	\label{fig:pavsup}
\end{figure}


Em testes simples, como andar em linha reta, o sistema se sai bem. Especificamente, o erro no eixo $y$ foi de cerca de 3 cm, e em $\theta$, abaixo de 0.05 radianos. Contudo, um comportamento estranho é visto no erro no eixo $x$, como ilustrado na figura \ref{fig:xzoado}\footnote{Note, também, que os erros em $x$ acabam causando prejuízos em $y$.}. A causa dessa oscilação não é conhecida e está sendo objeto de investigações.

\begin{figure}
	\centering
	\includegraphics[width=.9\columnwidth]{imagens/sonar/xzoado.png}
	\caption{Erros nas componentes $x$, $y$ e $\theta$ durante um teste do sonar. Os erros em $y$ e $\theta$ se mantêm dentro do esperado, mas o comportamento das estimativas no eixo $x$ não é correto.}
	\label{fig:xzoado}
\end{figure}

Testamos também a capacidade do sistema de se recuperar de associações erradas (figura \ref{fig:associacaoinvalida}) e erros na estimativa inicial (figura \ref{fig:estimativainicial}). Como pode ser visto na seção \ref{sec:sonar}, os sonares são mais adequados para corrigir a componente $y$ da postura\footnote{Pois o vetor $H$ depende, na coordenada $y$, do seno de $\theta_{wall}$. Na maior parte das vezes, $\theta_{wall}$ é $\frac{\pi}{2}$ -- existem mais paredes paralelas
ao eixo $x$ do que ao eixo $y$}, de modo que é nesse eixo que concentramos nossas avaliações. Note que em ambos os casos o sistema convergiu para a posição correta.

\begin{figure}
	\centering
	\includegraphics[width=.9\columnwidth]{imagens/sonar/recuperacaoestimativainicial.png}
	\caption{Sistema se recuperando de uma estimativa inicial de 1,17 metros.}
	\label{fig:estimativainicial}
\end{figure}

\begin{figure}
	\centering
	\includegraphics[width=.9\columnwidth]{imagens/sonar/associacaoinvalida.png}
	\caption{Sistema se recuperando após acreditar estar vendo uma parede errada.}
	\label{fig:associacaoinvalida}
\end{figure}

\subsection{Cronograma e RePlanejamento} 

Uma visão alto-nível do cronograma, que mostra claramente os atrasos inesperados com o Módulo de Localização, principalmente pelo componente de Sonar, que teve seu modelo totalmente recalculado, está disponível na figura \ref{fig:cronograma} abaixo.

\begin{figure}
	\centering
	\includegraphics[width=.9\columnwidth]{imagens/cronograma.jpg}
	\caption{Cronograma de uma visão alto nível do projeto.}
	\label{fig:cronograma}
\end{figure}

Dessa forma, nesse mês final, deveremos realizar sistematicamente as tarefas restantes, ou seja:

- Testar o nosso módulo de localização em campo;\\
- Integrar esse módulo ao sistema de planejamento (também com mais testes em campo);\\
- Interface Gráfica;\\
- Monografia (em andamento)