\section{Filtro de Kalman}
\label{sec:kalman}
A fim de estimar o posicionamento do robô a partir dos diversos sensores previamente descritos, uma técnica frequentemente utilizada é o filtro de Kalman. Este filtro opera de forma a minimizar o erro entre a estimativa de um estado e o estado real do processo por meio de duas técnicas: o método dos mínimos quadrados e a propagação de estados e covariâncias.

\subsection{Método dos mínimos quadrados}
Suponha que temos posse de um conjunto de medições sobre uma determinada constante, mas que estas medições foram adquiridas com um equipamento ruidoso. Cada medida é adquirida de forma independente e possui variâncias distintas.
Podemos modelar o problema como:
\begin{equation}
	y = Hx + v
\end{equation}
Onde y é um vetor com as medições, x é a constante a ser determinada, mas que também se apresenta em forma de vetor (iguais) e v é o ruído da medição.
Como supomos que as medições são independentes e com média nula, a matriz da covariância fica com a forma:
\begin{equation}
  R = 
	\left[
  \begin{array}{ccc}
	  \sigma^{2}_{1} & \cdots & 0 \\
	  \vdots & \ddots & \vdots \\
	  0 & \cdots & \sigma^{2}_{k} \\
	\end{array}
	\right]
\end{equation}
Considerando que o erro de cada medida é:
\begin{equation}
	\epsilon_{y}=y-H\widehat{x}
\end{equation}
Também em forma vetorial. Assim, o método dos mínimos quadrados consiste na minimização da seguinte função de custo:
\begin{equation}
	J=\frac{\epsilon^{2}_{y1}}{\sigma^{2}_{1}}+\cdots+\frac{\epsilon^{2}_{yk}}{\sigma^{2}_{k}}
\end{equation}
Como a própria modelagem do sistema nos informa, o método dos mínimos quadrados é a forma ótima de minimizar os erros provenientes de medições imprecisas, como é o problema que possuímos.\\
O problema com a abordagem acima é que todas as vezes que uma nova estimativa é acrescida ao sistema é necessário efetuar a multiplicação de H por x e minimizar J novamente. Para poucas medições isto é pouco oneroso, mas para o caso de muitas medidas, e.g., 10000 medições, a adição de uma medida implica na multiplicação de uma matriz 10001xN por outra Nx1, não aproveitando a estimativa obtida com as medições antigas. O método dos mínimos quadrados recursivo resolve esta questão, e é utilizado no filtro de kalman.\\
No entanto, ainda nos resta uma questão. Como estimar o estado e o erro do sistema entre duas medidas, sabendo-se que nosso robô estará em movimento.

\subsection{Propagação de estados e covariâncias}
Para obter uma estimativa correta do estado e da covariância após um determinado intervalo de tempo decorrido, iniciamos descrevendo um sistema contínuo gernérico:
\begin{equation}
	\dot{x}=Ax+Bu+w
\end{equation}
Onde \begin{math}x\end{math} é o estado do sistema, \begin{math}u\end{math} é uma variável de controle e \begin{math}w\end{math} é o ruído do sistema, com média nula e com distribuição gaussiana. Por ser uma equação diferencial, sabemos que a solução do sistema acima para um determinado tempo \begin{math}t_{k}\end{math} é:
\begin{equation}
	x(t_{k})=e^{A(t_{k}-t_{k-1})}x(t_{k-1})+\int^{t_{k}}_{t_{k-1}}e^{A(t_{k}-\tau)}[B(\tau)u(\tau)+w(\tau)]d\tau
\end{equation}
Agora fazendo a seguinte hipótese:
\begin{equation}
	u(t)=u_{k}, t \in [t_{k-1},t_{k}]
\end{equation}
E as seguintes definições:
\begin{equation}
	\Delta t=t_{k}-t_{k-1}
\end{equation}
\begin{equation}
	x_{k}=x(t_{k})
\end{equation}
\begin{equation}
	u_{k}=u(t_{k})
\end{equation}
\begin{equation}
	F_{k}=e^{A\Delta t}
\end{equation}
\begin{equation}
	G_{k}=\int^{t_{k+1}}_{t_{k}}e^{A(t_{k+1}-\tau)}B(\tau)d\tau
\end{equation}
A equação previamente fornecida é reescrita como:
\begin{equation}
	x_{k}=F_{k-1}x_{k-1}+G_{k-1}u_{k-1}+\int^{t_{k}}_{t_{k-1}}e^{A(t_{k}-\tau)}w(\tau)d\tau
\end{equation}
Obtendo a média da equação acima, lembrando que o ruído possui média nula, obtemos finalmente:
\begin{equation}
	\bar{x}_{k}=F_{k-1}\bar{x}_{k-1}+G_{k-1}u_{k-1}
\end{equation}
A propagação da matriz de covariâncias é dada pela seguinte fórmula:
\begin{equation}
	P_{k}=E[(x_{k}-\bar{x}_{k})(x_{k}-\bar{x}_{k})^{T}]
\end{equation}
Utilizando a equação anterior e assumindo como hipótese que \begin{math}w(t)\end{math} é um ruído branco de covariância \begin{math}Q_{c}(t)\end{math} chegamos após alguma manipulação matemática na sequinte equação:
\begin{equation}
	P_{k}=F_{k-1}P_{k-1}F^{T}_{k-1}+Q_{k-1}
\end{equation}
Onde \begin{math}Q_{k-1}\end{math} pode ser aproximado por
\begin{equation}
	Q_{k-1}\approx Q_{c}(t_{k})\Delta t
\end{equation}
e \begin{math}Q_{c}\end{math} é a covariância do ruído branco \begin{math}w(t)\end{math}.

\subsection{Filtro de Kalman discreto}
Finalmente, de posse da base teórica acima, podemos descrever o filtro de Kalman, que opera propagando o estado e a covariância no tempo e atualizando-os com os valores medidos, usando-se para isso o método dos mínimos quadrados. Em suma:
\begin{itemize}
	\item Uma descrição matemárica do problema para os quais a estimação dos estados são necessárias é realizada.
	\item Usamos as equações descritas anteriormente de propagação de estado e covariância.
	\item Toda vez que uma medida é obtida, a estimativa do estado e a covariância são atualizadas de forma a considerar o novo valor.
\end{itemize}
Vamos inicialmente modelar nosso sistema com a seguinte equação linear:
\begin{equation}
	x_{k}=F_{k-1}x_{k-1}+G_{k-1}u_{k-1}+w_{k-1}
\end{equation}
\begin{equation}
	y_{k}=H_{k}x_{k}+v_{k}
\end{equation}
Onde os ruídos \begin{math}w_{k}\end{math} e \begin{math}v_{k}\end{math} são brancos, centrados no zero, não correlatos e possuem matrizes de covariância \begin{math}Q\end{math} e \begin{math}R\end{math} respectivamente.\\
Para estimar o valor de \begin{math}x_{k}\end{math}, que é nosso objetivo final, vamos primeiramente subdividir \begin{math}x_{k}\end{math} em dois valores distintos, \begin{math}\hat{x}_{k}^{-}\end{math} e \begin{math}\hat{x}_{k}^{+}\end{math}, onde o primeiro corresponde a um valor antes de uma medida e o segundo após uma medida, i.e., \begin{math}\hat{x}_{k}^{-}\end{math} corresponde ao valor estimado baseado na dinâmica do sistema em um instante k instantâneamente antes de uma medição ser realizada, enquanto que \begin{math}\hat{x}_{k}^{+}\end{math} corresponde ao valor estimado no mesmo instante k após a obtenção de uma estimativa \begin{math}y_{k}\end{math}. De forma semelhante, definimos \begin{math}P_{k}^{-}\end{math} e \begin{math}P_{k}^{+}\end{math} como o valor da covariância antes e depois de uma medida.\\
Tendo definido estes estados e de posse da teoria previamente discutida, podemos descrever o processo de estimação através do filtro de Kalman com o seguinte processo:
\begin{itemize}
	\item Descrevemos matematicamente o sistema:
		\begin{equation}
			x_{k}=F_{k-1}x_{k-1}+G_{k-1}u_{k-1}+w_{k-1}
		\end{equation}
		\begin{equation}
			y_{k}=H_{k}x_{k}+v_{k}
		\end{equation}
		\begin{equation}
			E(w_{k}w^{T}_{j})=Q_{k}\delta_{k-j}
		\end{equation}
		\begin{equation}
			E(v_{k}v^{T}_{j})=R_{k}\delta_{k-j}
		\end{equation}	
		\begin{equation}
			E(w_{k}v^{T}_{j})=0
		\end{equation}	
	\item Inicializamos o filtro:
		\begin{equation}
			\hat{x}^{+}_{0}=E(x_{0})
		\end{equation}	
		\begin{equation}
			P^{+}_{0}=E[(x_{0}-\hat{x}^{+}_{0})(x_{0}-\hat{x}^{+}_{0})^{T}]
		\end{equation}
	\item Iteramos o filtro para cada uma das seguintes equações:
		\begin{equation}
			P^{-}_{k}=F_{k-1}P^{+}_{k-1}F^{T}_{k-1}+Q_{k-1}
		\end{equation}
		\begin{equation}
			\hat{x}^{-}_{k}=F_{k-1}\hat{x}^{+}_{k-1}+G_{k-1}u_{k-1}
		\end{equation}
		\begin{equation}
			K_{k}=P^{-}_{k}H^{T}_{k}(H_{k}P^{-}_{k}H^{T}_{k}+R_{k})^{-1}
		\end{equation}
		\begin{equation}
			\hat{x}^{+}_{k}=\hat{x}^{-}_{k}+K_{k}(y_{k}-H_{k}\hat{x}^{-}_{k})
		\end{equation}
		\begin{equation}
			P^{+}_{k}=(I-K_{k}H_{k})P^{-}_{k}(I-K_{k}H_{k})^{T}+K_{k}R_{k}K^{T}_{k}
		\end{equation}
\end{itemize}
Ou seja, iniciamos estimando um estado. Se temos certeza do mesmo,\begin{math}P_{0}^{+}=0\end{math}. A partir daí, propagamos o sistema no tempo até o momento da primeira medição, obtendo \begin{math}P_{k}^{-}\end{math} e \begin{math}\hat{x}_{k}^{-}\end{math}. Após isto, usamos a medida \begin{math}y_{k}\end{math} para atualizar a estimativa e covariância para \begin{math}P_{k}^{+}\end{math} e \begin{math}\hat{x}_{k}^{+}\end{math}.

\subsection{Filtro Estendido de Kalman}
O filtro de Kalman desenvolvido anteriormente é matematicamente o método ótimo de estimação de estados para sistemas lineares. No entanto, na natureza existem poucos sistemas lineares, a maioria são sistemas lineares, e o problema de estimação da posição do robô com sonares e visão computacional não é linear. Assim, é necessário um outro filtro para isso.\\
Foi desenvolvido uma versão extendida para estimação de sistemas não lineares, usado inicialmente para o sistema de navegação de espaçonaves, e atualmente é o filtro padrão para estimação de sistemas não lineares.\\
No filtro extendido, os estados de transição e modelos de observação não precisam ser funções lineares, podendo ser equações diferenciais. Em nossa formulação, usaremos o método hibrido de filtragem, que consiste em propagação de estado de forma contínua e atualização de estado com medidas de forma discreta. Isto porque nosso poder computacional nos permite propagar o estado segundo nosso modelo de dinâmica várias vezes entre duas medidas de sonares estarem disponíveis.\\
Assim, nosso sistema será descrito pelas seguintes equações:
\begin{equation}
	\dot{x}	= f(x,u,w,t)
\end{equation}
\begin{equation}
	y = h(x,v,t)
\end{equation}
Onde x é o estado, u é uma força de controle, w o ruído do processo e v o ruído da medição.\\
Estas equações nos bastam para predizer nossa estimativa e atualizá-la com a nova medida. No entanto, não há como diretamente aplicá-las na obtenção da covariância diretamente. Para obter a covariância, é realizada uma expansão de taylor de primeira ordem ao redor de cada estimativa, linearizando o sistema segundo uma função normalizada, e após isto utilizamos o filtro de Kalman discreto anteriormente descrito no sistema agora linear.\\
De forma a obter a covariância, utilizamos o jacobiano de f e h, obtendo $F_{k-1}$ e $H_{k}$, que serão utilizados nas equações de filtro linear, a saber:
\begin{equation}
	P^{-}_{k}=F_{k-1}P^{+}_{k-1}F^{T}_{k-1}+Q_{k-1}
\end{equation}
\begin{equation}
	K_{k}=P^{-}_{k}H^{T}_{k}(H_{k}P^{-}_{k}H^{T}_{k}+R_{k})^{-1}
\end{equation}
\begin{equation}
	P^{+}_{k}=(I-K_{k}H_{k})P^{-}_{k}
\end{equation}
É importante notar que para sistemas com não-linearidades muito grandes a expansão apresenta erros muito grandes. No entanto, para nosso problema o EKF apresenta performance satisfatória.