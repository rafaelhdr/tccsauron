\begin{comment}
\documentclass[a4paper,11pt]{article}
\usepackage{graphicx}
\usepackage[brazilian]{babel}
\usepackage[latin1]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{fullpage}
\usepackage{amsmath, amsthm, amssymb, bm}
\usepackage[ruled,vlined,portugues]{algorithm2e}
\usepackage{array}


\numberwithin{equation}{section}
\numberwithin{figure}{section}

\begin{document}
\end{comment}

\newcommand{\hx}{$h(\bar{\bf{x}})$}

\chapter{Modelos de Observação dos Sonares}\label{subsec:modelosonares}
\todo[inline]{Revisar a notação matemática das equações do sonar}
No contexto de localização robótica, um modelo de observação é usado para representar o comportamento de sensores e, em especial, como as medidas obtidas se relacionam com grandezas do ambiente observado. 

Como descrito na seção \ref{subsec:arqloc}, a localização bayesiana por filtro de Kalman estendido utiliza as informações dos sensores para corrigir a do estado atual. Essencialmente, a informação utilizada pelo filtro é a diferença entre a observação esperada (aqui indicada por $h(\hat{\bf{x}})$, onde $\hat{\bf{x}}$ é a estimativa da postura) e a observação real (denotada por $z$). Por exemplo, suponha um robô equipado com um sonar que incide perpendicularmente à uma parede, como na figura \ref{fig:exemplo_modelo}. Se ele estima estar em uma posição tal que a leitura esperada do sonar é 100 cm, mas a observação real é 80 cm, sabe-se que o robô está de fato mais perto da parede do que acredita. O papel do modelo de observação de um sensor é gerar as estimativas de observação \hx.

\begin{figure}[b]
	\centering
		\includegraphics{imagens/sonar/exemplo_modelo.pdf}
			\caption{Um modelo de observação é usado para estimar o erro entre a postura real ($\vec{x}$) e a postura estimada ($\hat{\bf{x}}$). Neste exemplo, um sonar perpendicular à parede recebe leitura $z$, mas o modelo de observação prevê, para a posição estimada $\hat{\bf{x}}$, a leitura \hx. Essa diferença será utilizada pelo EKF para corrigir a predição da postura.}
	\label{fig:exemplo_modelo}
\end{figure}

Foram desenvolvidos dois modelos de observação dos sonares. O sonar é um sensor de profundidade que emite ondas sonoras e, a partir do tempo entre emissão e recepção, calcula a distância ao obstáculo mais próximo. Ele opera de maneira similar a um sensor laser, mas com menor precisão e densidade. Contudo, um sensor laser é muito caro para algumas aplicações. Um dos objetivos deste projeto é construir um robô de baixo custo, utilizando sensores simples, de modo que a escolha do sonar se faz adequada.

\subsection{Modelo Baseado em Associações}
\label{sec:nossosonar}
A seção \ref{subsec:sonarbarra} apresentou o modelo de observação desenvolvido em \cite{barra}. O modelo de observação baseado em associações é uma modificação desse modelo. Em particular, as equações foram refeitas para incluir o efeito do ângulo relativo de cada sonar em relação ao centro do robô, e a manutenção de associações já realizadas foi facilitada através do método de rastreamento de paredes.

Este modelo é chamado de baseado em associações porque, antes de gerar observações esperadas e corrigir a postura predita, é necessária a confirmação de que um sonar está de fato observando uma determinada parede. A tarefa de relacionar as últimas leituras com uma parede do mapa chama-se associação. A principal motivação de um modelo deste tipo é diminuir os erros causados pelos sonares, dispositivos imprecisos.

De modo geral, a operação deste modelo pode ser dividida em quatro etapas. Primeiramente, as últimas $k$ observações são validadas e é determinado se uma parede está sendo vista pelo sonar. Se isso for verdade, consulta-se o mapa do ambiente de modo a se associar as leituras mais recentes a uma parede no mapa. Por fim, quando a associação é realizada com sucesso, determina-se a observação que seria esperada para a postura estimada do robô. A associação é registrada e o modelo tenta mantê-la nas próximas iterações, atribuindo uma pontuação para seu grau de confiança.

\paragraph{Validação das observações} As últimas $k$ observações são armazenadas, juntamente com a postura estimada em cada uma delas. Determina-se, através de um teste estatístico, se as observações podem corresponder a uma superfície plana. Também nesta fase, curvas realizadas pelo robô são detectadas. Nesse caso, o \textit{buffer} é limpo e a associação atual, se houver, é desfeita.

\paragraph{Associação das observações com o mapa} O mapa é então consultado para encontrar uma parede que corresponda às observações validadas. O processo é bastante conservador. Se o algoritmo de correspondência encontrar uma, e somente uma, parede que corresponda às leituras do sonar, a associação é realizada com sucesso.

\paragraph{Rastreamento de associações} Caso uma associação seja realizada com sucesso, dá-se início ao processo de rastreamento dessa associação. Para as próximas leituras realizadas pelo sonar, a etapa de associação das observações não é executada - ou seja, o mapa não é consultado e assume-se que a parede observada é aquela que está sendo rastreada. Estabelece-se uma pontuação para cada rastreamento, em função do erro entre as observações esperadas e obtidas. Quando a pontuação se torna negativa, o rastreamento se encerra.

\paragraph{Obtenção das observações esperadas} De posse da parede que o sonar está enxergando e da postura estimada do robô, retorna-se a leitura esperada do sonar.

Cada uma destas etapas serão detalhadas nas próximas seções.

\subsection{Validação das Observações}
\label{sec:validacao}
Define-se $k$ como o número de observações coletadas pelo sonar, e $k_{min}$ como o número mínimo de observações para que seja possível a validação de uma superfície plana. Enquanto $k<k_{min}$ a validação falhará. Quando $k=k_{min}$, inicia-se o processo de validação.

Para determinar se as últimas $k$ observações correspondem a uma parede, calcula-se a relação entre a diferença entre observações sucessivas e a distância percorrida pelo robô entre elas, em movimento retílineo. A figura \ref{fig:modelo_sonar} ilustra que, caso um sonar esteja observando uma superfície plana, as leituras do sensor se alinharão em um segmento de reta. Isso equivale a dizer que a relação entre as diferenças de leituras consecutivas e a distância percorrida entre essas leituras é constante. Matematicamente, seja $z_{i,j} = z^{(i)} - z^{(j)}$ a diferença entre duas medidas sucessivas e $d_{i,j}$ a distância percorrida entre elas, então:

\begin{equation}
\frac{z_{2,1}}{d_{2,1}} = \frac{z_{3,2}}{d_{3,2}} = \dots = \frac{z_{i,j}}{d_{i,j}} = \gamma
\end{equation}

Idealmente, a relação é perfeita e $\frac{z_{i,j}}{d_{i,j}} = \gamma$ para quaisquer $i$ e $j$. Naturalmente, erros de medida introduzem variações nas observações, de modo que:

\begin{equation}
\frac{z_{2,1}}{d_{2,1}} = \gamma_{2,1} \approx \frac{z_{3,2}}{d_{3,2}} = \gamma_{3,2} \approx \dots \approx \gamma_{i, j}
\end{equation}

\begin{figure}
	\centering
		\includegraphics{imagens/sonar/modelo_sonar.pdf}
		\caption{Representação das observações de um sonar com ângulo relativo $\theta'_{sonar}$. Os feixes do sonar incidem na parede com um ângulo $\beta$. Cada $z^{(i)}$ é uma observação, e $d_{i,j}$ é a distância percorrida entre as observações $i$ e $j$. Como a parede é uma superfície plana, a relação entre a diferença das leituras e a distância percorrida é constante.}
	\label{fig:modelo_sonar}
\end{figure}

Assumindo-se que um único segmento de reta está sendo visto (uma mesma parede) em todas as $k$ observações, podemos considerar que todos os elementos do conjunto formado por $\gamma$ são elementos de uma mesma distribuição normal. Se isso for verdade, as observações são validadas e passa-se à próxima fase do modelo de observação. O seguinte teste de hipótese pode ser utilizado para averiguar se o conjunto de $\gamma_{i,j}$ corresponde a uma distribuição normal:

\begin{equation*}
		H_{0}:\gamma ~ N(A, \sigma^{2}_{obsmedia})
\end{equation*}
\begin{equation*}
		H_{1}:\gamma ~ N(A, \sigma^{2}_{alternativo}), \sigma^{2}_{obsmedia} < \sigma^{2}_{alternativo}
\end{equation*}
sendo que o teste é realizado sobre a estatística $\chi^{2}$.
Para aceitar $H_{0}$, é verificado se $\chi^{2}$ é menor que um dado limite:
\begin{equation}
	\chi^{2}_{k-2} < \chi^{2}_{k-2,\alpha}
	\label{eq:chitest}
\end{equation}
onde o segundo termo é tabelado, $\alpha$ indica a confiança no teste e o primeiro termo é obtido da seguinte equação:
\begin{equation*}
	\chi^{2}_{k-2} = \frac{(k-2)s^{2}_{\gamma}}{\sigma^{2}_{obsmedia}}
\end{equation*}
onde $s^{2}_{\gamma}$ é a variância do conjunto formado pelos $\gamma_{i,i-1}$ de cada par de observações.

Considerando que todos os $\gamma_{i,i-1}$ pertencem à mesma distribuição de probabilidades, $\sigma^{2}_{obsmedia}$ é a variância esperada dessa distribuição. De acordo com \cite{barra}, seu valor é dado por:

\begin{equation}
\sigma^2_{obsmedia}=\sigma^2_{\gamma} = \vec{F}_\gamma \bm{\Sigma}_{\omega_{i,i-1}} \vec{F}_\gamma^{T} 
\end{equation}

\begin{align}
\vec{F}_\gamma=\frac{\partial\gamma(\omega_{i,i-1})}{\partial\omega_{i,i-1}}  |  \bm{\omega_{i,i-1}} = \bm{\bar{\omega}_{i,i-1}} = \notag \\
= \left( -\frac{(k-1)z_{i,i-1}}{d^{2}_{k,1}}~\frac{k-1}{d_{k,1}} \right) | \bm{\omega_{i,i-1}}
\end{align}

\begin{equation}
\bm{\Sigma}_{\omega_{i,i-1}} =
\begin{pmatrix}
\frac{\sigma^2_{d_{k,1}}}{(k-1)^2} & E_z\left[ z_{i, i-1} \frac{d_{k,1}}{k-1} \right] \\
 E_z\left[ z_{i, i-1} \frac{d_{k,1}}{k-1}\right] & \sigma^2_{z_{i,i-1}}
\end{pmatrix}
\end{equation}

\begin{equation}
\sigma^2_{z_{i,i-1}}=2\sigma^2_{obs} + \frac{\sigma^2_{d_{k,1}}}{(k-1)^2} \sin^2(\alpha)
\end{equation}

\begin{equation}
 E_z\left[ z_{i, i-1} \frac{d_{k,1}}{k-1} \right] = \frac{\sigma^2_{d_{k,1}} \sin(\alpha)}{(k-1)^2}
\end{equation}

\begin{equation}
\bm{w_{i,i-1}}=
\begin{pmatrix}
\frac{d_{k,1}}{k-1} & z_{i,i-1}
\end{pmatrix}^T
\end{equation}
Nas equações acima, $d_{k,1}$ é a distância percorrida pelo robô durante as últimas $k$ observações; $z_{i,j}$ é a diferença entre a leitura dos sonares nos instantes $i$ e $j$; $\sigma^2_{obs}$ é a incerteza da observação do sonar; $\sigma^2_{d_{k,1}}$ é a incerteza no deslocamento do robô e vale $\frac{d_{k,1}\sigma_{desloc}}{k-1}$, com $\sigma_{desloc}$ determinado experimentalmente; e $\alpha$ é o ângulo de incidência do robô com a parede observada. $\alpha$ pode ser calculado empiricamente do seguinte modo:

\begin{equation}
\sin \alpha=\frac{z_{k,1}\sin \theta'_{sonar}}{\sqrt{z_{k,1}^2 + d_{k,1}^2 - 2z_{k,1} d_{k,1} \cos \theta'_{sonar}}}
\label{eq:novoalpha}
\end{equation}

\subsection{Associação das observações com o mapa}\label{sec:associacao}
Se as $k$ observações armazenadas passarem no teste estatístico da equação \ref{eq:chitest}, procede-se com a busca de uma parede mapeada que corresponda às leituras validadas. O algoritmo utilizado trata as paredes como retas infinitas, definidas em termos de $r_{wall}$, o comprimento do segmento perpendicular à reta e que passa pela origem, e $\theta_{wall}$, o ângulo deste segmento com relação à origem. A figura \ref{fig:retas} ilustra essa convenção.

Duas etapas de eliminação são aplicadas sobre as paredes do mapa, de modo a reduzir o espaço de busca. Primeiramente, paredes que estejam fora do alcance do sonar são eliminadas; em seguida, paredes que estejam além do cone de visão do sonar também são desconsideradas.

\paragraph{Eliminação de paredes distantes}

Para cada parede do mapa, representada em termos de $r_{wall}$ e $\theta_{wall}$, calcula-se a distância perpendicular até a última posição predita do robô, $\bar{\bf{{x}}$. Caso essa distância seja maior do que um dado limite -- a faixa de operação do sonar utilizado --, rejeita-se esta parede como candidata a associação.

\paragraph{Eliminação de paredes pelo ângulo do sonar}

É necessário também eliminar as paredes candidatas pelo ângulo de abertura do sonar. Neste caso, as paredes não são tratadas como retas infinitas, e sim como segmentos. Um segmento só pode ser observado se um cone centrado na postura global do sonar com ângulo de abertura $\phi$ interseccioná-lo. O algoritmo \ref{algo:cone} descreve o comportamento desta etapa.

\begin{figure}[hbt]
	\centering
	\includegraphics[width=.5\columnwidth]{imagens/retas.pdf}
	\caption{O modelo adotado para representar as paredes do mapa, que são tratadas como retas infinitas. Cada reta é definida em termos de $r_{wall}$ e $\theta_{wall}$.}
	\label{fig:retas}
\end{figure}

\begin{algorithm}
	\dontprintsemicolon
	\SetKwData{bordau}{borda1}
	\SetKwData{bordad}{borda2}
	\SetKwData{eixo}{eixo}
	\SetKwData{parede}{parede}
	\SetKwData{pareta}{retaParede}
	\SetKwData{verdade}{verdadeiro}
	\SetKw{e}{e}
	\SetKw{lp}{$($}
	\SetKw{rp}{$)$}
	\SetKw{ou}{ou}
	\SetKwData{falso}{falso}
	\SetKwData{interbu}{interseçãoBorda1}
	\SetKwData{interbd}{interseçãoBorda2}
	
	\Entrada{A postura global predita do sonar, $(\bar{x}_{sonar}, \bar{y}_{sonar}, \bar{\theta}_{sonar})$, e seu ângulo de abertura, $\phi$}
	\Entrada{A parede, representada por um segmento de reta (\parede)}
	\Saida{\verdade se a parede for visível pelo sonar; \falso caso contrário}
	
	\Inicio{
		\pareta $\leftarrow$ a reta que contém \parede \;
		\bordau $\leftarrow$ a semireta com origem em $(\bar{x}_{sonar}, \bar{y}_{sonar})$ e inclinação $\bar{\theta}_{sonar} + \phi/2$ \;
		\bordad $\leftarrow$ a semireta com origem em $(\bar{x}_{sonar}, \bar{y}_{sonar})$ e inclinação $\hat{\theta}_{sonar} - \phi/2$ \;
		\eixo $\leftarrow$ a semireta  com origem em $(\bar{x}_{sonar}, \bar{y}_{sonar})$ e inclinação $\hat{\theta}_{sonar}$ \;
		\interbu $\leftarrow$ a interseção, se existir, entre \bordau e \pareta \;
		\interbd $\leftarrow$ a interseção, se existir, entre \bordad e \pareta \;
		\Se{\lp \interbu  \ou \interbd\ \rp \e \parede contém o ponto de interseção}{\Retorna{\verdade} \;}
		\SenaoSe{\interbu \e \interbd}{
			\SetKwData{seginter}{segmentoInterseções}
			\seginter $\leftarrow$ o segmento de reta que une as duas interseções \;
			\lSe{ \seginter contém \parede }{\Retorna{\verdade}} \;
			\lSenao{\Retorna{\falso}}
		}
		\SenaoSe{ \interbu \ou \interbd } {
			\SetKwData{angpu}{anguloExtremo1}
			\SetKwData{angpd}{anguloExtremo2}
			\angpu $\leftarrow$ $atan2($\parede.extremo1.y, \parede.extremo1.x$)$ \;
			\angpd $\leftarrow$ $atan2($\parede.extremo2.y, \parede.extremo2.x$)$ \;
			\lSe{
			$distanciaAngular($ \eixo, \angpu $) \leq \phi / 2$ \ou 
			$distanciaAngular($ \eixo, \angpd $) \leq \phi / 2$}{\Retorna{\verdade} \;
			} \;	
		}
		\Senao{ \Retorna{\falso}}	
	}
	\caption{Algoritmo de eliminação de uma parede pelo ângulo do sonar}
		\label{algo:cone}
\end{algorithm}

As paredes que passarem por ambos as etapas são candidatas à associação. Para que se possa selecionar a parede correta, é calculada a observação esperada para aquela parede, supondo correta a predição $\bar{\textbf{x}}$. Dá-se a essa observação esperada o nome de \hx, e seu cálculo é explicado na seção \ref{sec:obsesperada}. Averigua-se, então, a diferença entre \hx e $z$, a observação mais recente obtida do sonar. A ideia é rejeitar associações que produzam erros grandes demais.


O teste realizado é:

\begin{equation}
\frac{(z-h(\bar{\bf{x}}))^2}{\sigma_{obs}^2} < g^2,
\label{eq:testeassoc}
\end{equation}

onde $\sigma_{obs}^2$ é a variância das medidas e $g^2$ é um limite determinado experimentalmente. Se uma, e somente uma, parede do mapa passar pelo teste da equação \ref{eq:testeassoc}, considera-se a associação realizada com sucesso. Nesse caso, o modelo é capaz de produzir uma observação esperada, de acordo com a equação \ref{eq:hx}, e dá-se início à fase de rastreamento da associação.

\subsection{Rastreamento de associação}
Para a operação bem-sucedida do sistema de localização, é importante fornecer dados frequentemente, de modo a se corrigir a postura estimada com rapidez. É para aumentar essa taxa de correções que se desenvolveu o modo de rastreamento de associação, que entra em vigor assim que uma associação entre leituras e parede é realizada com sucesso.

Uma associação sendo rastreada tem associada a si uma pontuação numérica, iniciada com um valor pré-definido. A cada nova leitura gerada pelo sonar em um instante $t$, a pontuação $p$ é recalculada, do seguinte modo:

\begin{equation*}
	\epsilon_{t} = (z_t-h(\bar{\bf{x}}}_t))^2
\end{equation*}
\begin{equation*}
	\Delta_{\epsilon} = \epsilon_{t-1} - \epsilon_{t}
\end{equation*}
\begin{equation}
	p_t = p_{t-1} + K\Delta_{\epsilon},
\end{equation}

onde:

\begin{equation}
K = \left\{ 
\begin{array}{l l}
  K_{piora} & \quad \text{se $\Delta_{\epsilon} > 0$}\\
  K_{melhora} & \quad \text{se $\Delta_{\epsilon} < 0$}\\
\end{array} \right.
\end{equation}

A função da pontuação é representar a confiança que se tem naquela associação. Se os erros entre a observação esperada e a observação real diminuírem ou se mantiverem constantes, é sinal de que a associação não está tendo efeito negativo, e aumenta-se a pontuação. Por outro lado, se os erros estiverem aumentando, é desejado que a associação seja interrompida, pois é possível que não se esteja mais observando a mesma parede. De modo geral, deseja-se que $K_{piora} > K_{melhora}$ para evitar associações errôneas.

A pontuação de uma associação afeta também a covariância do erro do modelo de observação, R:

\begin{equation}
R = \begin{bmatrix}
	R_{base} + \frac{C}{p}
\end{bmatrix},
\label{eq:matrizr}
\end{equation}

onde $R_{base}$ e $C$ são constantes ajustadas experimentalmente.

Quando a pontuação de um rastreamento cai abaixo de zero, a associação é desfeita. Na próxima iteração do algoritmo do modelo de observação do sonar, a fase de associação descrita na seção \ref{sec:associacao} é realizada e, caso tenha sucesso, dá-se início a um novo rastreamento.

\subsection{Obtenção da Observação Esperada}
\label{sec:obsesperada}
Conhecida a parede que se está observando, o próximo passo é fornecer ao EKF as seguintes informações: a observação esperada para a postura estimada, \hx; a observação real obtida, $z$; a matriz de covariância, R e o jacobiano de \hx, a matriz G.

\paragraph{Cálculo da observação esperada}

Sejam $r_{wall}$ e $\theta_{wall}$ os parâmetros da reta sendo observada, e seja $(x_{sonar}, y_{sonar}, \theta_{sonar})$ a postura global do sonar. Nessas condições, a observação esperada pelo modelo de observação é:

\begin{equation*}
h(x) = \frac{r_{wall} - x_{sonar}\cos \theta_{wall} - y_{sonar}\sin \theta_{wall}}{\sin(\beta)},
\end{equation*}

onde $\beta$ é o ângulo de incidência do feixe do sonar com a parede. Seja $(x'_{sonar}, y'_{sonar}, \theta'_{sonar})$ a postura relativa do sonar, em relação ao centro do robô. Então $\beta = \theta'_{sonar} + \alpha$, onde $\alpha$ é o ângulo formado pela trajetória do robô e a parede sendo observada. Como $\alpha= \pi/2 - \theta_{wall} + \theta$, tem-se:

\begin{equation}
\beta=\theta'_{sonar}+ \frac{\pi}{2} - \theta_{wall} + \theta
\label{eq:beta}
\end{equation}

\begin{equation*}
h(x) = \frac{r_{wall} - x_{sonar}\cos \theta_{wall} - y_{sonar}\sin \theta_{wall}}{\sin(\theta'_{sonar} + (\frac{\pi}{2} - \theta_{wall}) + \theta)}
\end{equation*}

Por fim, passando para o sistema de coordenadas do robô, que está na posição $(x, y, \theta)$, chega-se à equação final:

\begin{equation}
h(x) = \frac{r_{wall} - (x + x'_{sonar} \cos \theta - y'_{sonar} \sin \theta)\cos \theta_{wall} - (y + x'_{sonar} \sin \theta + y'_{sonar} \cos \theta)\sin \theta_{wall}}{\sin(\theta'_{sonar} + (\frac{\pi}{2} - \theta_{wall}) + \theta)}
\end{equation}

\paragraph{Cálculo da covariância do erro da observação} A obtenção da matriz $\bm{R}$ é dada na equação \ref{eq:matrizr}.

\paragraph{Cálculo do jacobiano} A matriz H é necessária para que o EKF corrija a postura corretamente em cada componente. Ela é dada por:

\begin{equation*}
H = \left. \frac{\partial h(\vec{x})}{\partial \vec{x}}\right|_{\hat{x}}
\end{equation*}

\begin{equation}
H = \left(
    \begin{array}{>{\displaystyle}c}
			-\frac{\cos(\theta_{wall})}{\sin\beta} \\
			\\
	  	-\frac{\sin(\theta_{wall})}{\sin\beta} \\
	  	\\
	  	H_\theta
		\end{array}
		\right)^T,
	\label{eq:matrizh}
\end{equation}

onde $\beta$ é dado pela equação \ref{eq:beta} e:

\begin{equation}
H_\theta = \frac{\partial h(x)}{\partial\theta} = \frac{f'\sin\beta-f\cos\beta}{\sin^2\beta}
\end{equation}

\begin{equation}
f' = x'_{sonar} \sin(\theta-\theta_{wall}) + y'_{sonar} \cos(\theta-\theta_{wall})
\end{equation}
\begin{equation}
f = r_{wall} - (x + x'_{sonar} \cos \theta - y'_{sonar} \sin \theta)\cos \theta_{wall} - (y + x'_{sonar} \sin \theta + y'_{sonar} \cos \theta)\sin \theta_{wall}
\end{equation}

\subsection{Determinação dos Parâmetros do Modelo de Associações}

Há diversos parâmetros utilizados no modelo de associações. Nesta seção, os valores utilizados na implementação do projeto são listados.

\paragraph{Parâmetros do robô} A incerteza nas observações, $\sigma^2_{obs}$, foi determinada por \cite{barra}, utilizando a mesma plataforma deste trabalho, como 625 $mm^2$. Da mesma maneira, foi estabelecido $\sigma^2_{deslocamento}$ como 0.05 m. O ângulo de abertura do sonar, denotado $\phi$, foi estabelecido por \cite{barra} como 30º.
\paragraph{Parâmetros de validação e associação} A quantidade mínima de observações, $k_{min}$, foi determinada através de testes como 4. Além disso, as últimas 10 observações são armazenadas. A taxa de confiança no teste da equação \ref{eq:chitest} foi determinada por \cite{barra} como 50\% -- um valor baixo, mas que corresponde bem à realidade das incertezas do sonar. Determinou-se-se que um valor para $g^2$, utilizado no teste de associação da equação \ref{eq:testeassoc}, igual a 15 gera resultados bons. Também empiricamente, determinou-se 400 cm como um limite para a eliminação de paredes distantes candidatas à associação.

\paragraph{Parâmetros de rastreamento} A pontuação de uma associação recém-iniciada foi definida como 50. As constantes $K_{piora}$ e $K_{melhora}$ utilizadas foram, respectivamente, 4 e 3. No cálculo da equação da covariância do erro, equação \ref{eq:matrizr}, $R_{base} = 10$ e $C=300$. Quando a pontuação é zero, define-se a covariância do erro como 500.

\section{Modelo Simples de Observação dos Sonares}\label{subsec:modeloSimplesSonar}

O desempenho do modelo de observação baseado em associações nos testes realizados foi abaixo do esperado, devido a fatos discutidos na seção \ref{sec:discussao}. O principal problema encontrado foi a baixa frequência de associações, o que motivou o desenvolvimento de um modelo mais simples, e, portanto, mais veloz.

O ciclo de operação do modelo simples é curto e eficiente. Cada vez que uma leitura é fornecida pelo sonar, obtém-se a posição predita do robô naquele instante. De posse dessa informação, e do mapa, é descoberta a parede que seria observada caso a predição da postura estivesse correta. Calcula-se, então, a observação que seria esperada para aquela parede, e compara-se esse valor com a leitura real.

\subsection{Eliminação de Leituras Espúrias}

No modelo anterior, um método sofisticado é descrito para garantir que as últimas $k$ leituras correspondam a uma distribuição normal, como explicado na seção \ref{sec:validacao}. Já este modelo garante apenas que leituras erradas não sejam consideradas. Por erradas, entende-se medidas acima de 5 metros, o valor utilizado pelos sensores para indicar que nenhum obstáculo foi encontrado.

É importante notar que essa diferença de abordagem torna o modelo simples muito mais suscetível a leituras espúrias geradas por obstáculos dinâmicos.

\subsection{Determinação da Parede e Observação Esperada}

Quando o modelo recebe uma leitura, o gerenciador de localização é consultado de modo a se obter a predição da postura. O mapa é consultado para se obter a parede que, caso o robô de fato estivesse naquela posição, seria observada. Feito isso, a observação esperada pode ser obtida facilmente. O algoritmo \ref{algo:modelosimples} descreve o funcionamento desta etapa.

\begin{algorithm}[h]
\dontprintsemicolon
	\SetKwData{parede}{parede}
	\SetKwData{paredes}{paredes}
	\SetKwData{parobs}{paredeObservada}
	\SetKwData{deltaX}{deltaX}
	\SetKwData{deltaY}{deltaY}
	\SetKwData{tamanho}{alcanceSonar}
	\SetKwData{feixe}{feixeSonar}
	\SetKwData{distmin}{distanciaMinima}
	
	\SetKw{recebe}{$\leftarrow$}
	\SetKw{Em}{em}
	\SetKw{Ou}{ou}
	\Entrada{A postura global estimada do sonar, $(\bar{x}_{sonar}, \bar{y}_{sonar}, \bar{\theta}_{sonar})$}
	\Entrada{A lista de paredes do mapa, \paredes }
	\Entrada{O alcance máximo do sonar, \tamanho }
	\Saida{A observação esperada}
	\deltaX \recebe \tamanho * $\cos\bar{\theta}_{sonar}$ \;
	\deltaY \recebe \tamanho * $\sin\bar{\theta}_{sonar}$ \;
	\feixe \recebe segmento com extremos $(\bar{x}_{sonar}, \bar{y}_{sonar})$ e $(\bar{x}_{sonar} + \deltaX, \bar{y}_{sonar} + \deltaY)$ \;
	\distmin \recebe $-1$ \;
	\ParaCada{\parede \Em \paredes}{
		\Se{\feixe intersecta \parede}{
			\Se{\distmin = -1 \Ou distanciaAtéInterseção < \distmin}{
				\distmin \recebe distanciaAtéInterseção \;
				\parobs \recebe \parede \;
			}
		}
	}
	\Se{\distmin $\neq -1$}{
		\Retorna{\distmin}
	}
	
	\caption{O algoritmo do modelo simples de observação.}
	\label{algo:modelosimples}
\end{algorithm}

\subsection{Obtenção da Matriz de Covariância e do Jacobiano}
O passo final do modelo de observação é fornecer ao EKF a matriz de covariância e o jacobiano H:

\begin{equation}
R = \begin{bmatrix}
	R_{simples}
\end{bmatrix},
\end{equation}

O jacobiano $\bm{H}$ é o mesmo da equação \ref{eq:matrizh}.

\subsection{Determinação dos Parâmetros do Modelo Simples}

Os únicos parâmetros configuráveis no modelo simples são o limite máximo do alcance do sonar, e $R_{simples}$, a covariância. O limite máximo teórico do sonar é de 5 metros, mas estabeleceu-se 4 metros como o alcance do modelo. Acima dessa distância, experimentos relatam degeneração significativa da precisão das leituras. $R_{simples}$ foi definido como 60 $cm^2$.



%\end{document}